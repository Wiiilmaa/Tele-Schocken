{% extends "base.html" %}

{% block content %}
<div class="page-content" style="padding: 16px; max-width: 1100px; margin: 0 auto;">
<div style="text-align:right;">
  <button class="floating-icon-btn" onclick="toggleTheme()" title="Dark Mode umschalten" style="position:static;display:inline-flex;">
    <span class="icon-moon"><svg viewBox="0 0 512 512" fill="currentColor" width="16" height="16"><path d="M283.211 512c78.962 0 151.079-35.925 198.857-94.792 7.068-8.708-.639-21.43-11.562-19.35-124.203 23.654-238.262-71.576-238.262-196.954 0-72.222 38.662-138.635 101.498-174.394 9.686-5.512 7.25-20.197-3.756-22.23A258.156 258.156 0 0 0 283.211 0c-141.309 0-256 114.511-256 256 0 141.309 114.511 256 256 256z"/></svg></span>
    <span class="icon-sun"><svg viewBox="0 0 512 512" fill="currentColor" width="16" height="16"><path d="M256 160c-52.9 0-96 43.1-96 96s43.1 96 96 96 96-43.1 96-96-43.1-96-96-96zm246.4 80.5l-94.7-47.3 33.5-100.4c4.5-13.6-8.4-26.5-21.9-21.9l-100.4 33.5-47.4-94.8c-6.4-12.8-24.6-12.8-31 0l-47.3 94.7L92.7 70.8c-13.6-4.5-26.5 8.4-21.9 21.9l33.5 100.4-94.7 47.4c-12.8 6.4-12.8 24.6 0 31l94.7 47.3-33.5 100.5c-4.5 13.6 8.4 26.5 21.9 21.9l100.4-33.5 47.3 94.7c6.4 12.8 24.6 12.8 31 0l47.3-94.7 100.4 33.5c13.6 4.5 26.5-8.4 21.9-21.9l-33.5-100.4 94.7-47.3c12.8-6.4 12.8-24.6 0-31z"/></svg></span>
  </button>
</div>

<!-- Login -->
<div id="login-section">
  <h2>Protokoll &amp; Statistiken</h2>
  <p>Bitte Admin-Passwort eingeben:</p>
  <div class="input-group" style="max-width: 400px;">
    <input id="admin-password" type="password" class="form-control" placeholder="Passwort"
           onkeydown="if(event.key==='Enter')doLogin()">
    <div class="input-group-btn">
      <button class="btn btn-primary" onclick="doLogin()">Anmelden</button>
    </div>
  </div>
  <p id="login-error" style="color:red; margin-top:8px; display:none;"></p>
</div>

<!-- Admin Content (hidden until login) -->
<div id="admin-content" style="display:none;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
    <h2 style="margin:0;">Protokoll &amp; Statistiken</h2>
    <button class="btn btn-default btn-sm" onclick="doLogout()">Abmelden</button>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="main-tabs" style="margin-bottom: 16px;">
    <li class="active"><a href="#" onclick="switchTab('persons',this);return false;">Personen</a></li>
    <li><a href="#" onclick="switchTab('mappings',this);return false;">Zuordnungen</a></li>
    <li><a href="#" onclick="switchTab('stats',this);return false;">Statistiken</a></li>
    <li><a href="#" onclick="switchTab('io',this);return false;">Import/Export</a></li>
  </ul>

  <!-- ==================== TAB: Personen ==================== -->
  <div id="tab-persons" class="tab-panel">
    <h4>Personen verwalten</h4>
    <div class="input-group" style="max-width: 400px; margin-bottom: 12px;">
      <input id="new-person-name" type="text" class="form-control" placeholder="Neue Person"
             onkeydown="if(event.key==='Enter')addPerson()">
      <div class="input-group-btn">
        <button class="btn btn-primary" onclick="addPerson()">Hinzufügen</button>
      </div>
    </div>
    <table class="table table-striped table-hover" style="max-width: 600px;">
      <thead><tr><th>Name</th><th style="width:140px;">Aktionen</th></tr></thead>
      <tbody id="persons-tbody"></tbody>
    </table>
  </div>

  <!-- ==================== TAB: Zuordnungen ==================== -->
  <div id="tab-mappings" class="tab-panel" style="display:none;">
    <h4>Nick &rarr; Person Zuordnungen</h4>
    <div style="margin-bottom:12px;">
      <label><input type="checkbox" id="filter-incomplete" onchange="loadGames()" style="transform:scale(1);margin-right:4px;">
        Nur unvollständige anzeigen</label>
    </div>
    <div id="games-list"></div>
  </div>

  <!-- ==================== TAB: Statistiken ==================== -->
  <div id="tab-stats" class="tab-panel" style="display:none;">
    <h4>Statistiken</h4>
    <div style="margin-bottom:16px; display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
      <div>
        <label>Von:</label><br>
        <input type="date" id="stat-date-from" class="form-control" style="width:auto;">
      </div>
      <div>
        <label>Bis:</label><br>
        <input type="date" id="stat-date-to" class="form-control" style="width:auto;">
      </div>
      <div>
        <label>Person:</label><br>
        <select id="stat-person" class="form-control" style="width:auto;">
          <option value="">-- Alle --</option>
        </select>
      </div>
      <div>
        <button class="btn btn-primary" onclick="loadStats()">Anzeigen</button>
      </div>
    </div>

    <div id="stats-content" style="display:none;">
      <p><strong>Gesamt: <span id="stats-total"></span> Spiele</strong></p>

      <h4>Spieltage</h4>
      <table class="table table-striped table-hover" style="max-width:800px;">
        <thead><tr><th>Datum</th><th>Nicks</th><th>Zuordnungen</th></tr></thead>
        <tbody id="stats-days-tbody"></tbody>
      </table>

      <h4>Spiele</h4>
      <table class="table table-striped table-hover" style="max-width:800px;">
        <thead><tr><th>Datum</th><th>Verlierer</th><th>Gegenspieler</th></tr></thead>
        <tbody id="stats-games-tbody"></tbody>
      </table>

      <h4>Bier-Summe</h4>
      <div id="stats-beer-content"></div>
    </div>
  </div>

  <!-- ==================== TAB: Import/Export ==================== -->
  <div id="tab-io" class="tab-panel" style="display:none;">
    <h4>CSV Export</h4>
    <p style="color:var(--text-muted);">Format: <code>Datum(dd.mm.yyyy);"Verlierer";"Gewinner1";"Gewinner2";...</code></p>
    <p>Exportiert die aktuell unter "Statistiken" gewählten Filter.</p>
    <button class="btn btn-primary" onclick="doExport()">Export herunterladen</button>

    <hr>
    <h4>CSV Import</h4>
    <p style="color:var(--text-muted);">Gleices Format wie Export. Personen-Namen, die bereits als Person existieren, werden automatisch zugeordnet.</p>
    <textarea id="import-csv" class="form-control" rows="8" placeholder='Beispiel:&#10;25.01.2026;"Max";"Anna";"Tom"'></textarea>
    <button class="btn btn-primary" style="margin-top:8px;" onclick="doImport()">Importieren</button>
    <p id="import-result" style="margin-top:8px; display:none;"></p>

    <hr>
    <h4>Daten löschen</h4>
    <p style="color:var(--text-muted);">Spiele im angegebenen Datumsbereich löschen (z.B. Testspiele oder vor erneutem Import).</p>
    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
      <div>
        <label>Von:</label><br>
        <input type="date" id="delete-date-from" class="form-control" style="width:auto;">
      </div>
      <div>
        <label>Bis:</label><br>
        <input type="date" id="delete-date-to" class="form-control" style="width:auto;">
      </div>
      <div>
        <button class="btn btn-danger" onclick="doDelete()">Löschen</button>
      </div>
    </div>
    <p id="delete-result" style="margin-top:8px; display:none;"></p>
  </div>

</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
var _persons = [];
var _nickMappings = {};

// ==================== Auth ====================

function doLogin() {
  var pw = document.getElementById('admin-password').value;
  var errEl = document.getElementById('login-error');
  errEl.style.display = 'none';
  xhrJSON('POST', '/api/protokoll/auth', {password: pw}, function(res, status) {
    if (status === 200) {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('admin-content').style.display = '';
      loadAll();
    } else {
      errEl.textContent = res.Message || 'Fehler';
      errEl.style.display = '';
    }
  });
}

function doLogout() {
  xhrJSON('DELETE', '/api/protokoll/auth', null, function() {
    document.getElementById('admin-content').style.display = 'none';
    document.getElementById('login-section').style.display = '';
    document.getElementById('admin-password').value = '';
  });
}

function checkAuth() {
  xhrJSON('GET', '/api/protokoll/auth', null, function(res, status) {
    if (status === 200 && res.authenticated) {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('admin-content').style.display = '';
      loadAll();
    }
  });
}

// ==================== Tabs ====================

function switchTab(name, el) {
  var panels = document.querySelectorAll('.tab-panel');
  for (var i = 0; i < panels.length; i++) panels[i].style.display = 'none';
  document.getElementById('tab-' + name).style.display = '';
  var lis = document.querySelectorAll('#main-tabs li');
  for (var i = 0; i < lis.length; i++) lis[i].className = '';
  if (el) el.parentNode.className = 'active';
}

// ==================== Load All ====================

function loadAll() {
  loadPersons();
  loadNickMappings();
  loadGames();
}

// ==================== Persons ====================

function loadPersons() {
  xhrJSON('GET', '/api/protokoll/persons', null, function(res) {
    _persons = res;
    renderPersons();
    updatePersonSelects();
  });
}

function renderPersons() {
  var tbody = document.getElementById('persons-tbody');
  tbody.innerHTML = '';
  for (var i = 0; i < _persons.length; i++) {
    var p = _persons[i];
    var tr = document.createElement('tr');
    tr.innerHTML = '<td>' + esc(p.name) + '</td>' +
      '<td>' +
      '<button class="btn btn-default btn-xs" onclick="editPerson(' + p.id + ',\'' + escAttr(p.name) + '\')">Bearbeiten</button> ' +
      '<button class="btn btn-danger btn-xs" onclick="deletePerson(' + p.id + ',\'' + escAttr(p.name) + '\')">Löschen</button>' +
      '</td>';
    tbody.appendChild(tr);
  }
}

function addPerson() {
  var inp = document.getElementById('new-person-name');
  var name = inp.value.trim();
  if (!name) return;
  xhrJSON('POST', '/api/protokoll/persons', {name: name}, function(res, status) {
    if (status === 201) {
      inp.value = '';
      loadPersons();
    } else {
      alert(res.Message || 'Fehler');
    }
  });
}

function editPerson(id, oldName) {
  var newName = prompt('Neuer Name für "' + oldName + '":', oldName);
  if (!newName || newName.trim() === oldName) return;
  xhrJSON('PUT', '/api/protokoll/persons/' + id, {name: newName.trim()}, function(res, status) {
    if (status === 200) {
      loadPersons();
      loadGames();
    } else {
      alert(res.Message || 'Fehler');
    }
  });
}

function deletePerson(id, name) {
  if (!confirm('Person "' + name + '" wirklich löschen? Alle Zuordnungen gehen verloren.')) return;
  xhrJSON('DELETE', '/api/protokoll/persons/' + id, null, function(res, status) {
    if (status === 200) {
      loadPersons();
      loadGames();
    } else {
      alert(res.Message || 'Fehler');
    }
  });
}

function updatePersonSelects() {
  var sel = document.getElementById('stat-person');
  var oldVal = sel.value;
  sel.innerHTML = '<option value="">-- Alle --</option>';
  for (var i = 0; i < _persons.length; i++) {
    var opt = document.createElement('option');
    opt.value = _persons[i].id;
    opt.textContent = _persons[i].name;
    sel.appendChild(opt);
  }
  sel.value = oldVal;
}

// ==================== Nick Mappings ====================

function loadNickMappings() {
  xhrJSON('GET', '/api/protokoll/nick_mappings', null, function(res) {
    _nickMappings = res;
  });
}

// ==================== Games / Mappings ====================

function loadGames() {
  var incomplete = document.getElementById('filter-incomplete').checked;
  var url = '/api/protokoll/games?incomplete=' + incomplete;
  xhrJSON('GET', url, null, function(res) {
    renderGames(res);
  });
}

function renderGames(games) {
  var container = document.getElementById('games-list');
  if (games.length === 0) {
    container.innerHTML = '<p style="color:var(--text-muted);">Keine Spiele gefunden.</p>';
    return;
  }

  var html = '';
  var currentDate = '';
  for (var i = 0; i < games.length; i++) {
    var g = games[i];
    if (g.game_date !== currentDate) {
      if (currentDate) html += '</div>';
      currentDate = g.game_date;
      html += '<h5 style="margin-top:16px;">' + formatDate(g.game_date) + '</h5><div>';
    }
    var statusIcon = g.mapping_complete ? '&#9989;' : '&#9888;&#65039;';
    html += '<div class="game-mapping-card" style="border:1px solid var(--border-color);padding:10px;margin-bottom:8px;border-radius:4px;background:var(--bg-secondary);">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
    html += '<span>' + statusIcon + ' Spiel #' + g.id + '</span>';
    html += '<button class="btn btn-primary btn-xs" onclick="saveMapping(' + g.id + ')">Speichern</button>';
    html += '</div>';
    html += '<table class="table" style="margin:8px 0 0 0;"><thead><tr><th>Nick</th><th>Rolle</th><th>Person</th></tr></thead><tbody>';
    for (var j = 0; j < g.players.length; j++) {
      var p = g.players[j];
      var role = p.is_loser ? '<strong style="color:var(--message-start);">Verlierer</strong>' : 'Gewinner';
      html += '<tr><td>' + esc(p.nick) + '</td><td>' + role + '</td><td>';
      html += '<select class="form-control mapping-select" data-player-id="' + p.id + '" data-game-id="' + g.id + '" style="width:auto;display:inline-block;">';
      html += '<option value="">-- nicht zugeordnet --</option>';
      var suggested = _nickMappings[p.nick] || null;
      var assigned = p.person_id;
      for (var k = 0; k < _persons.length; k++) {
        var selected = '';
        if (assigned && assigned == _persons[k].id) selected = ' selected';
        else if (!assigned && suggested && suggested == _persons[k].id) selected = ' selected';
        html += '<option value="' + _persons[k].id + '"' + selected + '>' + esc(_persons[k].name) + '</option>';
      }
      html += '</select></td></tr>';
    }
    html += '</tbody></table></div>';
  }
  if (currentDate) html += '</div>';
  container.innerHTML = html;
}

function saveMapping(gameId) {
  var selects = document.querySelectorAll('.mapping-select[data-game-id="' + gameId + '"]');
  var mappings = {};
  for (var i = 0; i < selects.length; i++) {
    var playerId = selects[i].getAttribute('data-player-id');
    var val = selects[i].value;
    mappings[playerId] = val ? parseInt(val) : null;
  }
  xhrJSON('PUT', '/api/protokoll/games/' + gameId + '/mapping', {mappings: mappings}, function(res, status) {
    if (status === 200) {
      loadGames();
      loadNickMappings();
    } else {
      alert(res.Message || 'Fehler');
    }
  });
}

// ==================== Statistics ====================

function loadStats() {
  var dateFrom = document.getElementById('stat-date-from').value;
  var dateTo = document.getElementById('stat-date-to').value;
  var personId = document.getElementById('stat-person').value;
  var params = [];
  if (dateFrom) params.push('date_from=' + dateFrom);
  if (dateTo) params.push('date_to=' + dateTo);
  if (personId) params.push('person_id=' + personId);
  var url = '/api/protokoll/statistics' + (params.length ? '?' + params.join('&') : '');

  xhrJSON('GET', url, null, function(res) {
    document.getElementById('stats-content').style.display = '';
    document.getElementById('stats-total').textContent = res.total_games;
    renderStatsDays(res.game_days);
    renderStatsGames(res.game_results);
    renderStatsBeer(res.beer_summary);
  });
}

function renderStatsDays(days) {
  var tbody = document.getElementById('stats-days-tbody');
  tbody.innerHTML = '';
  for (var i = 0; i < days.length; i++) {
    var d = days[i];
    var mappingStr = Object.keys(d.mappings).map(function(nick) {
      return nick + ' = ' + d.mappings[nick];
    }).join(', ');
    var tr = document.createElement('tr');
    tr.innerHTML = '<td>' + formatDate(d.date) + '</td>' +
      '<td>' + d.nicks.map(esc).join(', ') + '</td>' +
      '<td>' + esc(mappingStr) + '</td>';
    tbody.appendChild(tr);
  }
}

function renderStatsGames(games) {
  var tbody = document.getElementById('stats-games-tbody');
  tbody.innerHTML = '';
  for (var i = 0; i < games.length; i++) {
    var g = games[i];
    var tr = document.createElement('tr');
    tr.innerHTML = '<td>' + esc(g.date) + '</td>' +
      '<td><strong>' + esc(g.loser) + '</strong></td>' +
      '<td>' + g.winners.map(esc).join(', ') + '</td>';
    tbody.appendChild(tr);
  }
}

function renderStatsBeer(summary) {
  var container = document.getElementById('stats-beer-content');
  if (summary.length === 0) {
    container.innerHTML = '<p style="color:var(--text-muted);">Keine Daten.</p>';
    return;
  }
  var html = '';
  for (var i = 0; i < summary.length; i++) {
    var s = summary[i];
    html += '<h5>' + esc(s.person) + '</h5>';
    html += '<table class="table table-striped" style="max-width:600px;">';
    html += '<thead><tr><th>Gegenspieler</th><th>Gibt</th><th>Bekommt</th><th>Differenz</th></tr></thead><tbody>';
    for (var j = 0; j < s.opponents.length; j++) {
      var o = s.opponents[j];
      var diffClass = o.diff > 0 ? 'color:#4CAF50;' : (o.diff < 0 ? 'color:#e53935;' : '');
      var diffPrefix = o.diff > 0 ? '+' : '';
      html += '<tr><td>' + esc(o.opponent) + '</td>' +
        '<td>' + o.gives + '</td>' +
        '<td>' + o.gets + '</td>' +
        '<td style="font-weight:bold;' + diffClass + '">' + diffPrefix + o.diff + '</td></tr>';
    }
    html += '</tbody></table>';
  }
  container.innerHTML = html;
}

// ==================== Import / Export ====================

function doExport() {
  var dateFrom = document.getElementById('stat-date-from').value;
  var dateTo = document.getElementById('stat-date-to').value;
  var personId = document.getElementById('stat-person').value;
  var params = [];
  if (dateFrom) params.push('date_from=' + dateFrom);
  if (dateTo) params.push('date_to=' + dateTo);
  if (personId) params.push('person_id=' + personId);
  var url = '/api/protokoll/export' + (params.length ? '?' + params.join('&') : '');
  window.location.href = url;
}

function doImport() {
  var csvText = document.getElementById('import-csv').value.trim();
  if (!csvText) { alert('Bitte CSV-Daten eingeben.'); return; }
  var resultEl = document.getElementById('import-result');
  resultEl.style.display = 'none';

  xhrJSON('POST', '/api/protokoll/import', {csv: csvText}, function(res, status) {
    resultEl.textContent = res.Message || 'Fertig';
    resultEl.style.color = status === 200 ? '#4CAF50' : '#e53935';
    resultEl.style.display = '';
    if (status === 200) {
      loadGames();
      loadNickMappings();
    }
  });
}

function doDelete() {
  var dateFrom = document.getElementById('delete-date-from').value;
  var dateTo = document.getElementById('delete-date-to').value;
  if (!dateFrom || !dateTo) { alert('Bitte Von- und Bis-Datum angeben.'); return; }
  if (!confirm('Wirklich alle Spiele von ' + dateFrom + ' bis ' + dateTo + ' löschen?')) return;

  var resultEl = document.getElementById('delete-result');
  resultEl.style.display = 'none';

  xhrJSON('DELETE', '/api/protokoll/games', {date_from: dateFrom, date_to: dateTo}, function(res, status) {
    resultEl.textContent = res.Message || 'Fertig';
    resultEl.style.color = status === 200 ? '#4CAF50' : '#e53935';
    resultEl.style.display = '';
    if (status === 200) loadGames();
  });
}

// ==================== Helpers ====================

function xhrJSON(method, url, data, callback) {
  var xhr = new XMLHttpRequest();
  xhr.open(method, url);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.onreadystatechange = function() {
    if (xhr.readyState === XMLHttpRequest.DONE) {
      var res = {};
      try { res = JSON.parse(xhr.responseText); } catch(e) {}
      callback(res, xhr.status);
    }
  };
  xhr.send(data ? JSON.stringify(data) : null);
}

function esc(s) {
  if (!s) return '';
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function escAttr(s) {
  return (s || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

function formatDate(isoDate) {
  if (!isoDate) return '';
  var parts = isoDate.split('-');
  if (parts.length === 3) return parts[2] + '.' + parts[1] + '.' + parts[0];
  return isoDate;
}

// Init
checkAuth();
</script>
{% endblock %}

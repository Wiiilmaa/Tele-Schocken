{% extends "base.html" %}

{% block content %}
{{ super() }}

<div class="row col-md-offset-1 col-xs-offset-1">
  <div class="col-md-9 col-xs-7" style="text-align: center">
    <h2 class="message" id="Message"></h2>
  </div>
  <div class="col-md-1 col-xs-2">
    <a class="roundetb" id="rulesBtn" href="#" onclick="showRules(); return false;" style="margin-right:8px;"><i class="fas fa-book" title="Regeln"></i></a>
    <a class="roundetb" id="faqBtn" href="#"><i class="fas fa-question" title="Fragen?"></i></a>
  </div>
</div>
<div class="container-fluid">
  <div class="row">
    <div class="col-xs-6 col-md-offset-1 col-md-2">
      <h3 id="StackChips_id">Chips: {{game.stack}}</h3>
    </div>
    <div class="clearfix visible-xs-block visible-sm-block"></div>
    <div class="col-xs-6 col-md-3">
      <h3 id="throw_id">Anzahl Würfe:</h3>
      <p id="throw_number_id" hidden></p>
    </div>
    <div class="col-xs-6 col-md-3">
      <h3 id="waiting_id">Warten auf: {{game.moveName(game.move_user_id)}}</h3>
      <p id="UUID" hidden>{{game.UUID}}</p>
      <p id="admin_id" hidden>{{game.admin_user_id}}</p>
      <p id="first_user_id" hidden>{{game.first_user_id}}</p>
      <p id="first_user_dice_count_id" hidden>3</p>
    </div>
  </div>
</div>

<div class="row ">
  <div class="col-md-11 col-md-offset-1">
    <h2 id="ownuser">Spieler:</h2>
  </div>
</div>

<!-- Game controls: visible for active players only -->
<div id="game_controls">
<div class="container-fluid">
  <div class="row ">
    <div class="col-xs-6 col-md-2 col-md-offset-1">
      <div class="col-xs-6 col-md-6 ">
        <div class="containerturner" id='startgame_id'>
          <img src="{{ url_for('static', filename = 'image/throw_the_dice.svg')}}" alt="throw the dice">
          <button id='btn_dice' onclick="dice()" class="btn" title="Würfeln">Würfeln</button>
          <p style="text-align: center">Würfeln</p>
        </div>
      </div>

      <div class="col-xs-1 col-md-2">
        <div class="row" style="white-space:nowrap">
          <button class="btn btn-primary" id='finishgame_id' onclick="finish()">Ende</button>
        </div>
        <div class="row" style="white-space:nowrap" id='set_passiv_div_id'>
          <input type="checkbox" title="Du wirst übersprungen bis die Runde ausgespielt ist" id="setpassivid"
            name="setpassivid" value="False" onchange="set_user_passiv(this)">
          <label for="setpassivid">Pause</label>
        </div>
      </div>
    </div>
    <div class="col-xs-6 col-md-3">
      <div class="col-xs-6 col-md-6">
        <div class="containercup">
          <img src="{{ url_for('static', filename = 'image/pulldiceup.svg')}}" alt="pull dice cup up">
          <button onclick="pullup()" class="btn" title="Aufdecken">Aufdecken</button>
          <p style="text-align: center">Aufdecken</p>
        </div>
      </div>
      <div class="col-xs-6 col-md-6 ">
        <div class="containercup">
          <img src="{{ url_for('static', filename = 'image/pulldicedown.svg')}}" alt="pull dice cup down">
          <button onclick="pulldown()" class="btn" title="Zudecken">Zudecken</button>
          <p style="text-align: center">Zudecken</p>
        </div>
      </div>
    </div>
    <div class="clearfix visible-xs-block visible-sm-block"></div>

    <div class="col-xs-12 col-md-3">
      <div class="row col-md-offset-1">
        <div class="col-xs-12 col-md-9 text-center">
          <p>Würfel für Becher wählen<br>Letzter Wurf muss aufgedeckt werden</p>
        </div>
      </div>
      <div class="clearfix visible-xs-block visible-sm-block"></div>
      <div class="row col-md-offset-1">
        <div class="col-xs-4 col-md-3 text-center">
          <input type="checkbox" id="dice1_cb" name="dice1" value="False" checked>
        </div>
        <div class="col-xs-4 col-md-3 text-center">
          <input type="checkbox" id="dice2_cb" name="dice2" value="False" checked>
        </div>
        <div class="col-xs-4 col-md-3 text-center">
          <input type="checkbox" id="dice3_cb" name="dice3" value="False" checked>
        </div>
      </div>
      <div class="clearfix visible-xs-block visible-sm-block"></div>
      <div class="row col-md-offset-1">
        <div class="col-xs-4 col-md-3">
          <div class="text-center" id="dice1_v">
          </div>
        </div>
        <div class="col-xs-4 col-md-3">
          <div class="text-center" id="dice2_v">
          </div>
        </div>
        <div class="col-xs-4 col-md-3 text-center">
          <div class="text-center" id="dice3_v">
          </div>
        </div>
      </div>
    </div>
    <div class="clearfix visible-xs-block visible-sm-block"></div>
    <div class="col-xs-12  col-md-3">
      <div id='2_6er' class="col-xs-6 col-md-6" hidden>
        <div class="containerturner">
          <img src="{{ url_for('static', filename = 'image/2_6er.svg')}}" alt="change two 6er against one 1er">
          <button onclick="turn1()" class="btn" title="6er drehen"></button>
        </div>
      </div>
      <div id='3_6er' class="col-xs-6 col-md-6" hidden>
        <div class="containerturner">
          <img src="{{ url_for('static', filename = 'image/3_6er.svg')}}" alt="change three 6er against two 1er">
          <button onclick="turn2()" class="btn" title="6er drehen"></button>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Join form: visible for visitors who are not in the game -->
<div id="join_form" style="display: none;">
  <div class="container-fluid">
    <div class="row">
      <div class="col-xs-12 col-md-6 col-md-offset-1">
        <h3>Spiel läuft -- Möchtest du mitspielen?</h3>
        <p>Du wirst sofort hinzugefügt, falls die aktuelle Runde noch nicht begonnen hat.
           Ansonsten wirst du nach Ende des aktuellen Spiels hinzugefügt.</p>
        <div class="input-group" style="max-width: 400px;">
          <input id="join_name" placeholder="Spielername" type="text" class="form-control">
          <div class="input-group-btn">
            <button class="btn btn-primary" onclick="joinMidGame()">Beitreten</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pending notice: visible for players waiting to join -->
<div id="pending_notice" style="display: none;">
  <div class="container-fluid">
    <div class="row">
      <div class="col-xs-12 col-md-6 col-md-offset-1">
        <h3>Du bist vorgemerkt und wirst nach Ende des aktuellen Spiels hinzugefügt.</h3>
      </div>
    </div>
  </div>
</div>

<div style="height:30px;" class="row col-md-offset-1 col-xs-offset-1">
</div>
<div class="row ">
</div>
<div class="row" data-example-id="striped-table">
  <div class="col-xs-12 col-md-10 col-md-offset-1">
    <table class="table table-striped table-hover table-sm" id="player_table">
      <thead>
        <tr>
          <th class="col-counter">#</th>
          <th>Name</th>
          <th class="col-chips">Chips</th>
          <th class="col-dice"></th>
          <th class="col-dice"></th>
          <th class="col-dice"></th>
          <th class="col-throws">Würfe</th>
          <th class="col-half">Hälften</th>
          <th id="finalcount_header" class="col-final" {% if not game.play_final %}style="display:none"{% endif %}>Runden</th>
        </tr>
      </thead>
      <tbody id="game_tbody">
      </tbody>
    </table>
  </div>
</div>

{% include "snippet/adminpanel.html" %}

{% include "snippet/game_play_faq.html" %}

<!-- Share link + QR code for mid-game joining -->
<div class="row" style="margin-top: 20px;">
  <div class="col-xs-12 col-md-10 col-md-offset-1">
    <h4>Mitspieler einladen:</h4>
    <div class="input-group" style="max-width: 500px;">
      <input id="share_link_input" type="text" class="form-control" readonly>
      <div class="input-group-btn">
        <button onclick="document.getElementById('share_link_input').select();document.execCommand('copy');" class="btn btn-outline-secondary" type="button">kopieren</button>
      </div>
    </div>
    <div id="share_qrcode" style="margin-top: 12px;"></div>
  </div>
</div>

{% block footer %}
{{ super() }}
{% endblock %}
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
  (function() {
    var loc = window.location;
    var gameUUID = document.getElementById('UUID').innerHTML.replace(/['"]+/g, '');
    var fullUrl = loc.protocol + '//' + loc.host + '/game_waiting/' + gameUUID;
    document.getElementById('share_link_input').value = fullUrl;
    new QRCode(document.getElementById('share_qrcode'), {
      text: fullUrl,
      width: 160,
      height: 160,
      colorDark: '#000000',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.M
    });
  })();
</script>
<script type=text/javascript src="{{url_for('static', filename='scripts/faq.js') }}">
</script>
<script type=text/javascript src="{{url_for('static', filename='scripts/adminpanel.js') }}">
</script>
<script type=text/javascript src="{{url_for('static', filename='scripts/socket.io.js') }}">
</script>
<script type=text/javascript src="{{url_for('static', filename='scripts/jquery-3.5.1.min.js') }}">
</script>

<script>

  // ============= H3: Sound handling =============
  var audioUnlocked = false;

  const soundDice = new Audio("{{ url_for('static', filename = 'audio/wuerfeln.mp3')}}");
  soundDice.preload = 'auto';
  const soundLift = new Audio("{{ url_for('static', filename = 'audio/hoch_die_Becher_Markus.mp3')}}");
  soundLift.preload = 'auto';
  const soundDiceY = new Audio("{{ url_for('static', filename = 'audio/wuerfelnYannick.mp3')}}");
  soundDiceY.preload = 'auto';

  // Preload
  try { soundDice.load(); soundLift.load(); soundDiceY.load(); } catch(e) {}

  function unlockAudio() {
    if (audioUnlocked) return;
    [soundDice, soundLift, soundDiceY].forEach(function(audio) {
      var p = audio.play();
      if (p) p.then(function() { audio.pause(); audio.currentTime = 0; }).catch(function() {});
    });
    audioUnlocked = true;
    document.removeEventListener('click', unlockAudio);
    document.removeEventListener('touchstart', unlockAudio);
  }
  document.addEventListener('click', unlockAudio);
  document.addEventListener('touchstart', unlockAudio);

  function playSound(audio) {
    if (!audio) return;
    audio.currentTime = 0;
    var p = audio.play();
    if (p !== undefined) {
      p.catch(function(e) { console.log('Sound konnte nicht abgespielt werden:', e.message); });
    }
  }

  // ============= Helpers =============
  var _lastGameState = null;  // cache for checking player status etc.
  var _lastRoundText = '';    // persisted "Letzte Runde" description across rounds

  function getGameId() {
    var el = document.getElementById('UUID');
    return el.innerHTML.replace(/['"]+/g, '');
  }

  function getMyId() {
    return parseInt(localStorage.getItem('id'));
  }

  // C2: Updated dicehelper -- returns null for null/0/undefined
  function dicehelper(eyes) {
    if (eyes === null || eyes === undefined || eyes === 0) return null;
    switch (eyes) {
      case 1: {
        var div = document.createElement('div');
        div.className = 'dice dice-first-face';
        var span = document.createElement('span');
        span.className = 'dot';
        div.appendChild(span);
        return div;
      }
      case 2: {
        var div = document.createElement('div');
        div.className = 'dice dice-second-face';
        var span = document.createElement('span');
        span.className = 'dot';
        var span2 = document.createElement('span');
        span2.className = 'dot';
        div.appendChild(span);
        div.appendChild(span2);
        return div;
      }
      case 3: {
        var div = document.createElement('div');
        div.className = 'dice dice-third-face';
        var span = document.createElement('span');
        span.className = 'dot';
        var span2 = document.createElement('span');
        span2.className = 'dot';
        var span3 = document.createElement('span');
        span3.className = 'dot';
        div.appendChild(span);
        div.appendChild(span2);
        div.appendChild(span3);
        return div;
      }
      case 4: {
        var div = document.createElement('div');
        div.className = 'dice dice-fourth-face';
        var divc1 = document.createElement('div');
        divc1.className = 'dice-column';
        var divc2 = document.createElement('div');
        divc2.className = 'dice-column';
        var span = document.createElement('span');
        span.className = 'dot';
        var span2 = document.createElement('span');
        span2.className = 'dot';
        var span3 = document.createElement('span');
        span3.className = 'dot';
        var span4 = document.createElement('span');
        span4.className = 'dot';
        divc1.appendChild(span);
        divc1.appendChild(span2);
        divc2.appendChild(span3);
        divc2.appendChild(span4);
        div.appendChild(divc1);
        div.appendChild(divc2);
        return div;
      }
      case 5: {
        var div = document.createElement('div');
        div.className = 'dice dice-fifth-face';
        var divc1 = document.createElement('div');
        divc1.className = 'dice-column';
        var divc2 = document.createElement('div');
        divc2.className = 'dice-column';
        var divc3 = document.createElement('div');
        divc3.className = 'dice-column';
        var span = document.createElement('span');
        span.className = 'dot';
        var span2 = document.createElement('span');
        span2.className = 'dot';
        var span3 = document.createElement('span');
        span3.className = 'dot';
        var span4 = document.createElement('span');
        span4.className = 'dot';
        var span5 = document.createElement('span');
        span5.className = 'dot';
        divc1.appendChild(span);
        divc1.appendChild(span2);
        divc2.appendChild(span3);
        divc3.appendChild(span4);
        divc3.appendChild(span5);
        div.appendChild(divc1);
        div.appendChild(divc2);
        div.appendChild(divc3);
        return div;
      }
      case 6: {
        var div = document.createElement('div');
        div.className = 'dice dice-fourth-face';
        var divc1 = document.createElement('div');
        divc1.className = 'dice-column';
        var divc2 = document.createElement('div');
        divc2.className = 'dice-column';
        var span = document.createElement('span');
        span.className = 'dot';
        var span2 = document.createElement('span');
        span2.className = 'dot';
        var span3 = document.createElement('span');
        span3.className = 'dot';
        var span4 = document.createElement('span');
        span4.className = 'dot';
        var span5 = document.createElement('span');
        span5.className = 'dot';
        var span6 = document.createElement('span');
        span6.className = 'dot';
        divc1.appendChild(span);
        divc1.appendChild(span2);
        divc1.appendChild(span3);
        divc2.appendChild(span4);
        divc2.appendChild(span5);
        divc2.appendChild(span6);
        div.appendChild(divc1);
        div.appendChild(divc2);
        return div;
      }
      default: return null;
    }
  }

  // Append dice element if non-null
  function appendDice(container, eyes) {
    var el = dicehelper(eyes);
    if (el) container.appendChild(el);
  }

  // C4: Check if any non-passive, non-pending user still has hidden dice
  function isUndecided(game) {
    var undecided = false;
    game.User.forEach(function(user) {
      if (!undecided && user.Passive !== true && user.Pending_Join !== true && user.Dices.length < 3)
        undecided = true;
    });
    return undecided;
  }

  // ============= Game Actions =============
  function dice() {
    document.getElementById("btn_dice").disabled = true;
    setTimeout(function () { document.getElementById("btn_dice").disabled = false; }, 2500);
    var dice1_cb = document.getElementById('dice1_cb');
    dice1_cb.disabled = false;
    var dice2_cb = document.getElementById('dice2_cb');
    dice2_cb.disabled = false;
    var dice3_cb = document.getElementById('dice3_cb');
    dice3_cb.disabled = false;

    var v3_6er_button = document.getElementById('3_6er');
    v3_6er_button.hidden = true;
    var v2_6er_button = document.getElementById('2_6er');
    v2_6er_button.hidden = true;

    var dice1_checked = document.getElementById('dice1_cb').checked;
    var dice2_checked = document.getElementById('dice2_cb').checked;
    var dice3_checked = document.getElementById('dice3_cb').checked;

    var dice1_v = document.getElementById('dice1_v');
    var dice2_v = document.getElementById('dice2_v');
    var dice3_v = document.getElementById('dice3_v');

    var gameid = getGameId();
    var id = localStorage.getItem('id');

    var dicenumber = document.getElementById('Number_Dice' + id);
    if (dicenumber) {
      var dn = parseInt(dicenumber.innerHTML);
      if (dn == 0) {
        if (!dice1_checked || !dice2_checked || !dice3_checked) {
          alert('Beim ersten Wurf alle Würfel in den Becher Packen!');
          document.getElementById("btn_dice").disabled = false;
          return;
        }
      }
    }

    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/api/game/" + gameid + "/user/" + id + "/dice");
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function () {
      if (xhttp.readyState == XMLHttpRequest.DONE) {
        var res = JSON.parse(xhttp.responseText);
        if (xhttp.status == 201) {
          if (res.fallen) {
            alert('Würfel vom Tisch gefallen Schnapsrunde!');
          } else {
            playSound(soundDice);

            if (dice1_checked) {
              dice1_v.className = "spin animated";
              dice1_v.style.animation = 'none';
              dice1_v.offsetHeight;
              dice1_v.style.animation = null;
            }
            if (dice2_checked) {
              dice2_v.className = "spin animated";
              dice2_v.style.animation = 'none';
              dice2_v.offsetHeight;
              dice2_v.style.animation = null;
            }
            if (dice3_checked) {
              dice3_v.className = "spin animated";
              dice3_v.style.animation = 'none';
              dice3_v.offsetHeight;
              dice3_v.style.animation = null;
            }
            dice1_v.innerHTML = '';
            dice2_v.innerHTML = '';
            dice3_v.innerHTML = '';
            appendDice(dice1_v, res.dice1);
            appendDice(dice2_v, res.dice2);
            appendDice(dice3_v, res.dice3);

            var anzahlel_first_mumber = document.getElementById('first_user_dice_count_id').innerHTML;
            var first_user_id = document.getElementById('first_user_id').innerHTML;
            var me = localStorage.getItem('id');

            if (first_user_id != me || res.number_dice == 3) {
              if (String(res.number_dice) == anzahlel_first_mumber || first_user_id == me) {
                if (dice1_checked) { dice1_v.style.display = "none"; dice1_v.style.animation = 'none'; }
                if (dice2_checked) { dice2_v.style.display = "none"; dice2_v.style.animation = 'none'; }
                if (dice3_checked) { dice3_v.style.display = "none"; dice3_v.style.animation = 'none'; }
              } else {
                dice1_v.style.display = "block";
                dice2_v.style.display = "block";
                dice3_v.style.display = "block";
                if (res.dice1 == 6 && res.dice2 == 6 || res.dice1 == 6 && res.dice3 == 6 || res.dice2 == 6 && res.dice3 == 6) {
                  v2_6er_button.hidden = false;
                }
                if (res.dice1 == 6 && res.dice2 == 6 && res.dice3 == 6) {
                  v3_6er_button.hidden = false;
                }
              }
            } else {
              dice1_v.style.display = "block";
              dice2_v.style.display = "block";
              dice3_v.style.display = "block";
              if (res.dice1 == 6 && res.dice2 == 6 || res.dice1 == 6 && res.dice3 == 6 || res.dice2 == 6 && res.dice3 == 6) {
                v2_6er_button.hidden = false;
              }
              if (res.dice1 == 6 && res.dice2 == 6 && res.dice3 == 6) {
                v3_6er_button.hidden = false;
              }
            }
          }
        } else {
          alert('' + res.Message);
        }
      }
    }
    xhttp.send(JSON.stringify({ dice1: dice1_checked, dice2: dice2_checked, dice3: dice3_checked }));
  }

  function set_user_passiv() {
    var id = localStorage.getItem('id');
    var gameid = getGameId();
    var userstate = document.getElementById('setpassivid').checked;
    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/api/game/" + gameid + "/user/" + id + "/passiv");
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function () {
      if (xhttp.readyState == XMLHttpRequest.DONE) {
        var res = JSON.parse(xhttp.responseText);
        if (xhttp.status != 200 && xhttp.status != 201) { alert('' + res.Message); }
      }
    }
    xhttp.send(JSON.stringify({ userstate: userstate }));
  }

  function finish() {
    var id = localStorage.getItem('id');
    var gameid = getGameId();
    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/api/game/" + gameid + "/user/" + id + "/finisch");
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function () {
      if (xhttp.readyState == XMLHttpRequest.DONE) {
        var res = JSON.parse(xhttp.responseText);
        if (xhttp.status != 200) { alert('' + res.Message); }
      }
    }
    xhttp.send(JSON.stringify({}));
  }

  // C3: Move DOM changes into success callback
  function pullup() {
    var id = localStorage.getItem('id');
    var gameid = getGameId();
    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/api/game/" + gameid + "/user/" + id + "/visible");
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function () {
      if (xhttp.readyState == XMLHttpRequest.DONE) {
        var res = JSON.parse(xhttp.responseText);
        if (xhttp.status == 201) {
          document.getElementById('dice1_v').style.display = "block";
          document.getElementById('dice2_v').style.display = "block";
          document.getElementById('dice3_v').style.display = "block";
        } else {
          alert('' + res.Message);
        }
      }
    }
    xhttp.send(JSON.stringify({ visible: true }));
  }

  function pulldown() {
    var id = localStorage.getItem('id');
    var gameid = getGameId();
    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/api/game/" + gameid + "/user/" + id + "/visible");
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function () {
      if (xhttp.readyState == XMLHttpRequest.DONE) {
        var res = JSON.parse(xhttp.responseText);
        if (xhttp.status == 201) {
          document.getElementById('dice1_v').style.display = "none";
          document.getElementById('dice2_v').style.display = "none";
          document.getElementById('dice3_v').style.display = "none";
        } else {
          alert('' + res.Message);
        }
      }
    }
    xhttp.send(JSON.stringify({ visible: false }));
  }

  function turn(count) {
    var dice1_cb = document.getElementById('dice1_cb');
    var dice2_cb = document.getElementById('dice2_cb');
    var dice3_cb = document.getElementById('dice3_cb');
    var dice1_v = document.getElementById('dice1_v');
    var dice2_v = document.getElementById('dice2_v');
    var dice3_v = document.getElementById('dice3_v');
    var gameid = getGameId();
    var id = localStorage.getItem('id');
    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/api/game/" + gameid + "/user/" + id + "/diceturn");
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function () {
      if (xhttp.readyState == XMLHttpRequest.DONE) {
        var res = JSON.parse(xhttp.responseText);
        if (xhttp.status == 201) {
          dice1_v.innerHTML = '';
          dice2_v.innerHTML = '';
          dice3_v.innerHTML = '';
          if (res.dice1) {
            appendDice(dice1_v, res.dice1);
            if (res.dice1 == 1) { dice1_cb.checked = false; }
          } else { dice1_cb.checked = true; dice1_cb.disabled = true; }
          if (res.dice2) {
            appendDice(dice2_v, res.dice2);
            if (res.dice2 == 1) { dice2_cb.checked = false; }
          } else { dice2_cb.checked = true; dice2_cb.disabled = true; }
          if (res.dice3) {
            appendDice(dice3_v, res.dice3);
            if (res.dice3 == 1) { dice3_cb.checked = false; }
          } else { dice3_cb.checked = true; dice3_cb.disabled = true; }
        } else {
          alert('' + res.Message);
        }
      }
    }
    xhttp.send(JSON.stringify({ count: count }));
  }

  function turn1() { turn(1); }
  function turn2() { turn(2); }

  // ============= Player/Admin checks =============
  function checkIfPlayer(game) {
    var myId = getMyId();
    var isPlayer = game.User.some(function(u) { return u.Id === myId; });
    var gameControls = document.getElementById('game_controls');
    var joinForm = document.getElementById('join_form');
    var pendingNotice = document.getElementById('pending_notice');

    if (!isPlayer) {
      gameControls.style.display = 'none';
      joinForm.style.display = 'block';
      pendingNotice.style.display = 'none';
    } else {
      var me = game.User.find(function(u) { return u.Id === myId; });
      if (me && me.Pending_Join) {
        gameControls.style.display = 'none';
        joinForm.style.display = 'none';
        pendingNotice.style.display = 'block';
      } else {
        gameControls.style.display = 'block';
        joinForm.style.display = 'none';
        pendingNotice.style.display = 'none';
      }
    }
  }

  // H2: Dynamically rebuild table rows to match game.User
  function updateTableRows(game) {
    var tbody = document.getElementById('game_tbody');
    var myId = getMyId();
    var isAdmin = game.Admins && game.Admins.indexOf(myId) !== -1;
    var showFinal = game.Ruleset && game.Ruleset.play_final;
    var finalHeader = document.getElementById('finalcount_header');
    if (finalHeader) finalHeader.style.display = showFinal ? '' : 'none';

    // Build current set of user IDs in table
    var existingRows = {};
    var rows = tbody.querySelectorAll('tr');
    for (var i = 0; i < rows.length; i++) {
      var rowId = rows[i].id;
      if (rowId && rowId.startsWith('row')) {
        existingRows[rowId.replace('row', '')] = rows[i];
      }
    }

    // Remove rows for users no longer in game
    var gameUserIds = {};
    game.User.forEach(function(u) { gameUserIds[u.Id] = true; });
    Object.keys(existingRows).forEach(function(uid) {
      if (!gameUserIds[uid]) {
        tbody.removeChild(existingRows[uid]);
      }
    });

    // Add/update rows for each user
    var counter = 1;
    game.User.forEach(function(juser) {
      var row = document.getElementById('row' + juser.Id);
      if (!row) {
        // Create new row
        row = document.createElement('tr');
        row.id = 'row' + juser.Id;
        row.innerHTML = '<td class="counterCell col-counter"></td>'
          + '<td id="user' + juser.Id + '"></td>'
          + '<td id="chips' + juser.Id + '" class="col-chips"></td>'
          + '<td id="dice1' + juser.Id + '" class="dice-cell col-dice"></td>'
          + '<td id="dice2' + juser.Id + '" class="dice-cell col-dice"></td>'
          + '<td id="dice3' + juser.Id + '" class="dice-cell col-dice"></td>'
          + '<td id="Number_Dice' + juser.Id + '" class="col-throws"></td>'
          + '<td id="first' + juser.Id + '" class="col-half"></td>'
          + '<td id="finalcount' + juser.Id + '" class="col-final"' + (showFinal ? '' : ' style="display:none"') + '></td>';
        tbody.appendChild(row);
      }

      // Counter
      row.querySelector('.counterCell').innerHTML = counter++;

      // G5: Pending player display
      if (juser.Pending_Join) {
        row.className = 'pending-row';
      } else {
        row.className = '';
      }

      // F4: Name + admin badge + leave icon
      var nameCell = document.getElementById('user' + juser.Id);
      var nameHtml = juser.Name;

      // Second line: status and/or leave icon
      var secondLine = '';
      if (juser.Pending_Join) secondLine += '<small>(wartet)</small> ';
      // Leave icon: green if active, gray only if user can toggle it (own or admin)
      var clickable = (juser.Id === myId || isAdmin);
      if (juser.Leave_After_Game) {
        secondLine += '<i class="fas fa-sign-out-alt leave-icon leave-active"'
          + ' title="Verlassen vorgemerkt (klicken zum Aufheben)"'
          + (clickable ? ' onclick="toggle_leave(' + juser.Id + ')"' : '')
          + '></i>';
      } else if (clickable) {
        secondLine += '<i class="fas fa-sign-out-alt leave-icon leave-inactive"'
          + ' title="Nach dem Spiel verlassen"'
          + ' onclick="toggle_leave(' + juser.Id + ')"'
          + '></i>';
      }
      if (secondLine) nameHtml += '<div>' + secondLine + '</div>';
      nameCell.innerHTML = nameHtml;

      // Chips
      document.getElementById('chips' + juser.Id).innerHTML = juser.Chips;

      // Halfcount
      document.getElementById('first' + juser.Id).innerHTML = juser.Halfcount;

      // Finalcount
      var fcEl = document.getElementById('finalcount' + juser.Id);
      if (fcEl) {
        fcEl.innerHTML = juser.Finalcount;
        fcEl.style.display = showFinal ? '' : 'none';
      }

      // Number of dice throws
      document.getElementById('Number_Dice' + juser.Id).innerHTML = juser.Number_Dice;

      // Dices in table
      var d1 = document.getElementById('dice1' + juser.Id);
      var d2 = document.getElementById('dice2' + juser.Id);
      var d3 = document.getElementById('dice3' + juser.Id);
      d1.innerHTML = '';
      d2.innerHTML = '';
      d3.innerHTML = '';
      if (juser.Dices && juser.Dices.length > 0) {
        for (var dn in juser.Dices) {
          var jdice = juser.Dices[dn];
          if (jdice['Dice1'] !== undefined) appendDice(d1, jdice['Dice1']);
          if (jdice['Dice2'] !== undefined) appendDice(d2, jdice['Dice2']);
          if (jdice['Dice3'] !== undefined) appendDice(d3, jdice['Dice3']);
        }
      }

      // Row background color
      if (juser.Pending_Join) {
        // Already handled by pending-row class
      } else if (juser.Id == game.First) {
        row.style.backgroundColor = "lightblue";
      } else if (juser.Passive) {
        row.style.backgroundColor = "lightgray";
      } else {
        row.style.backgroundColor = "#11ffee00";
      }
    });
  }

  // ============= Main refresh function =============
  function refresh_game(game) {
    _lastGameState = game;
    var gameid = getGameId();
    var waiting_user_id = game.Move;
    var waitinguserstorage = document.getElementById('waiting_id');
    var throwbutton = document.getElementById('startgame_id');
    var id = getMyId();
    var isAdmin = game.Admins && game.Admins.indexOf(id) !== -1;

    // Admin info
    var admininfo = document.getElementById('admin_information');
    if (admininfo) admininfo.innerHTML = 'Admin gespielte Hälften: ' + game['Game_Half_Count'];

    // H2: Toggle admin panel visibility dynamically
    var adminPanel = document.getElementById('admin_interface');
    if (adminPanel) {
      adminPanel.style.display = isAdmin ? 'block' : 'none';
    }

    // Check if player / pending / spectator
    checkIfPlayer(game);

    // Redirect to lobby if game returned to waiting
    var game_state = game['State'];
    if (game_state == 'waiting') {
      var getUrl = window.location;
      var baseUrl = getUrl.protocol + "//" + getUrl.host;
      window.location.replace(baseUrl + '/game_waiting/' + gameid);
      return;
    }

    var me_inactive = false;
    for (var num in game.User) {
      if (game.User[num]['Id'] == id && game.User[num]['Passive']) {
        me_inactive = true;
      }
    }

    // Stack chips
    document.getElementById('StackChips_id').innerHTML = 'Chips: ' + game.Stack;

    // First user
    var firstuser_id = game['First'];
    document.getElementById('first_user_id').innerHTML = firstuser_id;

    // First user dice count
    for (var num in game.User) {
      if (game.User[num].Id == firstuser_id) {
        var anzahlel = document.getElementById('throw_id');
        var anzahl_number_el = document.getElementById('throw_number_id');
        anzahlel.innerHTML = 'Anzahl Würfe: ' + game.User[num]['Number_Dice'];
        anzahl_number_el.innerHTML = game.User[num]['Number_Dice'];
        document.getElementById('first_user_dice_count_id').innerHTML = game.User[num]['Number_Dice'];
        break;
      }
    }

    // Game message
    var el_message = document.getElementById('Message');
    if (game.Message) {
      if (el_message.innerHTML != 'Nachricht: ' + game.Message) {
        if (game.Message.includes("Chip(s) von") || game.Message.includes("Schockaus") || game.Message.includes("Schock aus")
            || game.Message.includes("Chip(s) vom Stapel an") || game.Message.includes("hat das Finale verloren")
            || game.Message.includes("Finale wird gespielt")) {
          document.getElementById("dice1_cb").checked = true;
          document.getElementById("dice2_cb").checked = true;
          document.getElementById("dice3_cb").checked = true;
        }
        if (!me_inactive && game.Message.startsWith('Aufdecken')) {
          playSound(soundLift);
        }
        el_message.className = "message";
        el_message.style.animation = 'none';
        el_message.offsetHeight;
        el_message.style.animation = null;
      }
      el_message.innerHTML = 'Nachricht: ' + game.Message;
    } else {
      el_message.innerHTML = '';
    }

    // Count active (non-pending) players
    var activePlayerCount = 0;
    for (var num in game.User) {
      if (!game.User[num].Pending_Join) activePlayerCount++;
    }
    var notEnoughPlayers = activePlayerCount < 2 &&
        (game_state == 'started' || game_state == 'playfinal');

    // C4: Improved "Warten auf" display
    if (notEnoughPlayers) {
      waitinguserstorage.innerHTML = 'Warten auf: Mitspieler';
    } else if (waiting_user_id == -1) {
      if (isUndecided(game)) {
        waitinguserstorage.innerHTML = 'Warten auf: Aufdecken';
      } else {
        waitinguserstorage.innerHTML = 'Warten auf: Chip Verteilung';
      }
    } else {
      // Find the waiting user's name
      for (var num in game.User) {
        if (game.User[num]['Id'] == waiting_user_id) {
          // Sound when it's my turn
          if (game.Message) {
            if (waitinguserstorage.innerHTML != 'Warten auf: ' + game.User[num]['Name']) {
              if (game.User[num]['Id'] == id && !game.Message.startsWith('Aufdecken')) {
                playSound(soundDiceY);
              }
            }
          }
          waitinguserstorage.innerHTML = 'Warten auf: ' + game.User[num]['Name'];
          break;
        }
      }
    }

    // H2: Update table rows dynamically
    updateTableRows(game);

    // C1: Restore own dice cup from server state
    var me_data = null;
    for (var num in game.User) {
      if (game.User[num].Id == id) {
        me_data = game.User[num];
        break;
      }
    }
    if (me_data) {
      var dice1_v = document.getElementById('dice1_v');
      var dice2_v = document.getElementById('dice2_v');
      var dice3_v = document.getElementById('dice3_v');
      // Only restore if the cup area is currently empty (after reload)
      // or if we're not in the middle of a roll animation
      if (dice1_v.children.length === 0 && me_data.Number_Dice > 0) {
        // Restore dice from the Dices array
        if (me_data.Dices && me_data.Dices.length > 0) {
          dice1_v.innerHTML = '';
          dice2_v.innerHTML = '';
          dice3_v.innerHTML = '';
          for (var dn in me_data.Dices) {
            var jdice = me_data.Dices[dn];
            if (jdice['Dice1'] !== undefined) appendDice(dice1_v, jdice['Dice1']);
            if (jdice['Dice2'] !== undefined) appendDice(dice2_v, jdice['Dice2']);
            if (jdice['Dice3'] !== undefined) appendDice(dice3_v, jdice['Dice3']);
          }
          // Show dice if visible
          dice1_v.style.display = "block";
          dice2_v.style.display = "block";
          dice3_v.style.display = "block";
        }
      }

      // Passive checkbox
      if (game.Stack == 0 && me_data.Chips == 0 && me_data.Number_Dice == 0 && game_state != 'playfinal') {
        document.getElementById('set_passiv_div_id').style.display = "block";
      } else {
        document.getElementById('set_passiv_div_id').style.display = "none";
        document.getElementById('setpassivid').checked = false;
      }
    }

    // Throw button color and state
    if (notEnoughPlayers) {
      throwbutton.className = 'buttongray containerturner';
      throwbutton.disabled = true;
    } else if (id == waiting_user_id) {
      throwbutton.className = 'buttongreen containerturner';
      throwbutton.disabled = false;
    } else {
      throwbutton.className = 'buttongray containerturner';
      throwbutton.disabled = false;
    }

    // Unified round status row
    var roundRow = document.getElementById('round_status_row');
    var roundFinished = (waiting_user_id == -1);
    var needsReveal = roundFinished && isUndecided(game);
    var readyToDistribute = roundFinished && !needsReveal;

    if (readyToDistribute && game.Scoring) {
      // Phase: all dice visible, ready to distribute
      var chipsPart;
      if (game.Scoring.From === 'schockaus') {
        chipsPart = 'Schockaus! Alle Chips an ' + game.Scoring.To_Name;
      } else {
        chipsPart = game.Scoring.Chips + ' Chip(s) von '
                  + game.Scoring.From_Name + ' an ' + game.Scoring.To_Name;
      }
      var fullInfo = '<b>Hoch:</b> ' + game.Scoring.High
                   + ', <b>Tief:</b> ' + game.Scoring.Low
                   + ' — ' + chipsPart;
      _lastRoundText = fullInfo;
      roundRow.innerHTML = '<button class="btn btn-success" id="distribute_btn" '
        + 'onclick="distribute()" disabled>Verteilen</button> '
        + '<span>' + fullInfo + '</span>';
      // Enable button after 3s delay
      setTimeout(function() {
        var btn = document.getElementById('distribute_btn');
        if (btn) btn.disabled = false;
      }, 3000);
    } else if (needsReveal) {
      // Phase: waiting for reveal
      var voteHtml = '';
      if (game.Reveal_Votes > 0) {
        voteHtml = ' <span>(' + game.Reveal_Votes + ' Stimme(n))</span>';
      }
      roundRow.innerHTML = '<button class="btn btn-warning" onclick="vote_reveal_all()">'
        + 'Alles aufdecken</button>' + voteHtml;
    } else if (!roundFinished) {
      // Phase: game is running
      // On page reload _lastRoundText is lost; reconstruct from game message
      if (!_lastRoundText && game.Message && (game.Message.includes('Chip(s) von') || game.Message.includes('Schock aus'))) {
        _lastRoundText = game.Message;
      }
      if (_lastRoundText) {
        roundRow.innerHTML = '<span>Letzte Runde: ' + _lastRoundText + '</span>';
      } else {
        roundRow.innerHTML = '';
      }
    } else {
      roundRow.innerHTML = '';
    }

    // Lobby after game button
    var lobbyBtn = document.getElementById('mark_lobby_btn');
    if (lobbyBtn) {
      if (game.Lobby_After_Game) {
        lobbyBtn.className = 'btn btn-success btn-sm';
        lobbyBtn.innerHTML = 'Lobby nach dem Spiel geplant (klicken zum Aufheben)';
      } else {
        lobbyBtn.className = 'btn btn-warning btn-sm';
        lobbyBtn.innerHTML = 'Zurück zur Lobby nach dem Spiel';
      }
    }

    // H2: Update player select lists
    if (typeof updatePlayerSelects === 'function') {
      updatePlayerSelects(game);
    }

    // R6: Update rules display data
    if (game.Ruleset) {
      updateRulesModal(game.Ruleset);
    }
  }

  // R6: Build rules modal content
  function updateRulesModal(ruleset) {
    var title = document.getElementById('rules_title');
    var content = document.getElementById('rules_content');
    if (!title || !content) return;
    title.innerHTML = 'Regeln: ' + ruleset.name;
    var html = '<p><strong>Chips:</strong> ' + ruleset.stack_max + ' | <strong>Finale:</strong> ' + (ruleset.play_final ? 'Ja' : 'Nein') + '</p>';
    html += '<table class="table table-condensed"><thead><tr><th>Kombination</th><th>Name</th><th>Chips</th></tr></thead><tbody>';
    for (var i = 0; i < ruleset.rules.length; i++) {
      var r = ruleset.rules[i];
      html += '<tr><td>' + r.dice + '</td><td>' + r.name + '</td><td>' + (r.chips == -1 ? 'Alle (Schock aus)' : r.chips) + '</td></tr>';
    }
    html += '</tbody></table>';
    html += '<p><small>Alle weiteren Kombinationen: Schrott (1 Chip)</small></p>';
    content.innerHTML = html;
  }

  function initial_game_data() {
    var gameid = getGameId();
    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", "/api/game/" + gameid);
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function () {
      if (xhttp.readyState == XMLHttpRequest.DONE) {
        if (xhttp.status == 200) {
          var res = JSON.parse(xhttp.responseText);
          refresh_game(res);
        }
      }
    }
    xhttp.send(JSON.stringify({}));
  }

  function startup() {
    faq();
    var id = localStorage.getItem('id');
    var user = document.getElementById('ownuser');
    user.innerHTML = "Spieler: " + (localStorage.getItem('name') || '');
    initial_game_data();
  }

  startup();
</script>
<script type="text/javascript" charset="utf-8">
  namespace = '/game';

  const socket = io(namespace, {
    reconnection: true,
    reconnectionAttempts: Infinity,
    reconnectionDelay: 1000,
    reconnectionDelayMax: 5000,
    randomizationFactor: 0.5
  });

  socket.on('connect', function () {
    var game = document.getElementById('UUID');
    var gameid = game.innerHTML;
    gameid = gameid.replace(/^"(.+)"$/, '$1');
    socket.emit('join', { room: gameid });
  });

  socket.on('reload_game', function (game) {
    if (game) {
      refresh_game(game);
    }
  });
</script>
{% endblock %}

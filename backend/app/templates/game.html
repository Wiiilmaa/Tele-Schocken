{% extends "base.html" %}


{% block content %}
{{ super() }}
<div id="joincontainer">
  <div class="row col-md-offset-1">
    <div class="col-md-10">
      <h2>Zum Beitreten Spielname angeben.</h2>
    </div>
  </div>

  <div class="row col-md-offset-1">
    <div class="col-md-3 " >
      <div class="input-group mb-6">
        <input id="Name" placeholder="Spielername" type="text" size="20" class="form-control" >
        <div class="input-group-btn">
          <button id="jointbtn" class="btn btn-primary btn-outline-secondary" type="button" onclick="joinGame()">Beitreten</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row col-md-offset-1">
  <div class="col-md-10">
    <h3 id="admin"></h3>
  </div>
  <div class="col-md-1">
      <a class="roundetb" id="faqBtn" href="#"><i class="fas fa-question"></i></a>
  </div>
</div>
<br>

<div class="row">
  <div class="col-md-3 col-md-offset-1">
    <div class="row">
      <div class="col-md-12">
        <h2>Spielerliste:</h2>
      </div>
    </div>
    <table class="table table-striped table-hover" >
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
        </tr>
      </thead>
      <tbody id="player_tbody">
        {% for user in game.users %}
        <tr >
          <th class="counterCell" scope="row"></th>
            <td>
              {{ user.name }}{% if user.is_admin %} <span class="admin-badge"><i class="fas fa-star" title="Admin"></i></span>{% endif %}
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
  </div>
</div>


<div class="row col-md-offset-1 col-md-10">
    <h3>Verteile diesen Link an alle Mitspieler:</h3>
</div>
<div class="row">
  <div class="col-md-offset-1 col-md-4" >
    <div class="input-group mb-6">
      <input id="link_input" type="text" size="80" class="form-control" value="/game_waiting/{{game.UUID}}">
      <div class="input-group-btn">
        <button onclick="coppy()" class="btn btn-outline-secondary" type="button">kopieren</button>
      </div>
    </div>
  </div>
</div>
<div class="row col-md-offset-1 admin_interface">
  <div class="col-md-9">
    <h3>Spiel starten (<b>Du kannst Spieler auch nachtr√§glich hinzuf√ºgen</b>)</h3>
  </div>
</div>
<div class="row col-md-offset-1 admin_interface">
  <div class="col-md-9">
    <label for="ruleset_select">Ruleset w√§hlen:</label>
    <select name="ruleset_select" id="ruleset_select" class="form-select">
      <option value="">-- Wird geladen --</option>
    </select>
  </div>
</div>
<div class="row col-md-offset-1 admin_interface">
  <div class="col-md-1" >
    <button class="btn btn-primary" id='startgame_id' onclick="startGame()" disabled>Starten</button>
    <div id="inline_button_text" >
      <h3>üëà</h3>
    </div>
  </div>
</div>


<div class="row col-md-offset-1 col-md-10" >
    <p id="admin_id" hidden>{{ game.admin_user_id }}</p>
    <p id="admins_data" hidden>{{ game.users | selectattr('is_admin') | map(attribute='id') | list }}</p>
</div>
<div class="row col-md-offset-1 col-md-10" >
    <p id="UUID" hidden>{{game.UUID}}</p>
</div>
{% if game.ruleset_id %}
<p id="current_ruleset_id" hidden>{{game.ruleset_id}}</p>
{% endif %}



<div class="row col-md-offset-1">
<!-- The Modal -->
  <div id="faqModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
      <div class="modal-header">
        <span id="faqclose" class="close">&times;</span>
        <h2>H√§ufige Fragen</h2>
      </div>
      <div class="modal-body">
        <button class="accordion">Wie starte ich ein Spiel?</button>
        <div class="panel">
          <p>Wenn die gew√ºnschten Spieler in der Spielerliste aufgetaucht sind, einfach auf den Button Starten klicken.</p>
          <p>Das Spiel startet dann automatisch f√ºr alle Mitspieler!</p>
          <p>Nur ein Admin kann das Spiel starten</p>
            <div class="col-md-11 col-md-offset-1 example_img">
              <picture>
                <img alt="FAQ Spiel Starten" style="width:80%; height:auto;" src="{{ url_for('static',filename='image/start_game.png') }}">
              </picture>
            </div>
        </div>
        <button class="accordion">Warum sehe ich keine Mitspieler?</button>
        <div class="panel">
          <p>Es werden nur die Mitspieler angezeigt die du eingeladen hast und die deiner Einladung gefolgt sind.</p>
          <p>Sobald jemand deinen link ge√∂ffnet hat und beigetreten ist taucht dieser in der Spielerliste auf.</p>
          <p>Kopiere den Link zur Einladung √ºber den Button kopieren und verteile diesen per Mail oder Messanger deiner Wahl.</p>
          <div class="col-md-11 col-md-offset-1 example_img">
            <picture>
              <img alt="FAQ Mitspieler Einladen" style="width:80%; height:auto;" src="{{ url_for('static',filename='image/ShareLink.png') }}">
            </picture>
          </div>
        </div>
        <button class="accordion">Das Spiel h√§ngt irgendwie, was kann ich tun?</button>
        <div class="panel">
          <p>Es ist irgendetwas schief gegangen beim letzten Update der Seite.</p>
          <p>Ich Arbeite an der L√∂sung</p>
          <p>Lade die Seite einmal neu (du bleibst im Spiel und es kann direkt weiter gehen).</p>
          <p>Ich bitte die Unanehmichkeit zu entschuldigen</p>
        </div>
      </div>
    </div>
  </div>
</div>


{% block footer %}
{{ super() }}
{% endblock %}

{% endblock %}
{% block scripts %}
{{ super() }}

<script type=text/javascript src="{{url_for('static', filename='scripts/faq.js') }}">
</script>
<script type=text/javascript src="{{url_for('static', filename='scripts/socket.io.js') }}">
</script>
<script type=text/javascript src="{{url_for('static', filename='scripts/jquery-3.5.1.min.js') }}">
</script>

<script>
  // https://www.w3schools.com/howto/howto_js_copy_clipboard.asp
  function coppy() {
    var copyText = document.getElementById("link_input");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    document.execCommand("copy");
  }

  var _rulesets = [];

  function loadRulesets() {
    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", "/api/rulesets");
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function() {
      if (xhttp.readyState == XMLHttpRequest.DONE && xhttp.status == 200) {
        _rulesets = JSON.parse(xhttp.responseText);
        var select = document.getElementById('ruleset_select');
        select.innerHTML = '';
        for (var i = 0; i < _rulesets.length; i++) {
          var opt = document.createElement('option');
          opt.value = _rulesets[i].id;
          opt.innerHTML = _rulesets[i].name;
          select.appendChild(opt);
        }
        // Pre-select current ruleset if returning to lobby
        var currentEl = document.getElementById('current_ruleset_id');
        if (currentEl && currentEl.innerHTML.trim()) {
          select.value = currentEl.innerHTML.trim();
        }
      }
    }
    xhttp.send();
  }

  function joinGame() {
    var user = document.getElementById('Name');
    var game = document.getElementById('UUID');
    var uuid = game.innerHTML;
    uuid = uuid.replace(/^"(.+)"$/,'$1');
    var usernname = user.value;
    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/api/game/"+uuid+"/user");
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function() {
      if (xhttp.readyState == XMLHttpRequest.DONE) {
        var res = JSON.parse(xhttp.responseText);
        if (xhttp.status != 200) {
          alert('Fehler beim erzeugen: '+res.Message);
          location = location;
        } else {
          localStorage.setItem('name', usernname);
          for (num in res.User) {
            var juser = res.User[num];
            var name = juser['Name'];
            if (name == usernname) {
              localStorage.setItem('id', juser['Id']);
            }
          }
          window.location.href = "/game_waiting/"+uuid;
        }
      }
    }
    xhttp.send(JSON.stringify({name: usernname}));
  }

  function startGame() {
    var game = document.getElementById('UUID');
    var gameid = game.innerHTML;
    gameid = gameid.replace(/^"(.+)"$/,'$1');

    var rulesetSelect = document.getElementById('ruleset_select');
    var rulesetId = rulesetSelect.value;
    var myId = parseInt(localStorage.getItem('id'));

    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/api/game/"+gameid+"/start");
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function() {
      if (xhttp.readyState == XMLHttpRequest.DONE) {
        if (xhttp.status != 201) {
          try {
            var res = JSON.parse(xhttp.responseText);
            alert(''+res.Message);
          } catch (e) {
            alert('Allgemeiner Fehler');
          }
        }
      }
    }
    xhttp.send(JSON.stringify({ruleset_id: rulesetId, admin_id: myId}));
  }

  function isAdminUser() {
    var myId = parseInt(localStorage.getItem('id'));
    // Check from the game state if available
    if (window._currentGame && window._currentGame.Admins) {
      return window._currentGame.Admins.indexOf(myId) !== -1;
    }
    // Fallback: check from template data
    var adminEl = document.getElementById('admin_id');
    if (adminEl) {
      return myId == parseInt(adminEl.innerHTML);
    }
    return false;
  }

  function startup() {
    faq();
    var gameLink = document.getElementById("link_input");
    gameLink.value = window.location.href;

    loadRulesets();

    var id = localStorage.getItem('id');
    var setdamin = document.getElementById('admin');

    // Fetch game state to check admin status
    var game = document.getElementById('UUID');
    var gameid = game.innerHTML;
    gameid = gameid.replace(/^"(.+)"$/,'$1');

    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", "/api/game/" + gameid);
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function() {
      if (xhttp.readyState == XMLHttpRequest.DONE && xhttp.status == 200) {
        var gameData = JSON.parse(xhttp.responseText);
        window._currentGame = gameData;
        var myId = parseInt(id);
        var amAdmin = gameData.Admins && gameData.Admins.indexOf(myId) !== -1;

        if (!amAdmin) {
          var all_admin_elements = document.getElementsByClassName("admin_interface");
          for (var i = 0; i < all_admin_elements.length; i++) {
            all_admin_elements[i].style.display = "none";
          }
          var button = document.getElementById('startgame_id');
          button.style.display = "none";
          var hand = document.getElementById('inline_button_text');
          hand.style.display = "none";
          setdamin.innerHTML = 'Bitte warte bis ein Admin das Spiel startet.';
        } else {
          var joincontainer = document.getElementById('joincontainer');
          joincontainer.style.display = "none";
          var button = document.getElementById('startgame_id');
          button.disabled = false;
          var hand = document.getElementById('inline_button_text');
          hand.style.webkitAnimationName = 'run';
          setdamin.innerHTML = 'Du bist Admin. Bitte starten wenn alle Spieler in der Liste stehen.';
        }
      }
    }
    xhttp.send();
  }
  startup();
</script>

<script type="text/javascript" charset="utf-8">
  namespace = '/game';

  const socket = io(namespace, {
    reconnection: true,
    reconnectionAttempts: Infinity,
    reconnectionDelay: 1000,
    reconnectionDelayMax: 5000,
    randomizationFactor: 0.5
  });

  socket.on('connect', function() {
    var game = document.getElementById('UUID');
    var gameid = game.innerHTML;
    gameid = gameid.replace(/^"(.+)"$/,'$1');
    socket.emit('join', {room: gameid});
  });

  socket.on('reload_game', function(game, cb) {
    if (game) {
      var game_el = document.getElementById('UUID');
      var gameid = game_el.innerHTML;
      gameid = gameid.replace(/^"(.+)"$/,'$1');

      window._currentGame = game;
      var id = localStorage.getItem('id');
      var res = game;
      var sate = res.State;

      // Update admin visibility dynamically
      var myId = parseInt(id);
      var amAdmin = res.Admins && res.Admins.indexOf(myId) !== -1;
      var all_admin_elements = document.getElementsByClassName("admin_interface");
      var setdamin = document.getElementById('admin');
      if (amAdmin) {
        for (var i = 0; i < all_admin_elements.length; i++) {
          all_admin_elements[i].style.display = '';
        }
        var joincontainer = document.getElementById('joincontainer');
        joincontainer.style.display = "none";
        var button = document.getElementById('startgame_id');
        button.disabled = false;
        button.style.display = '';
        var hand = document.getElementById('inline_button_text');
        hand.style.display = '';
        if (setdamin) setdamin.innerHTML = 'Du bist Admin. Bitte starten wenn alle Spieler in der Liste stehen.';
      } else {
        for (var i = 0; i < all_admin_elements.length; i++) {
          all_admin_elements[i].style.display = "none";
        }
        var button = document.getElementById('startgame_id');
        button.style.display = "none";
        var hand = document.getElementById('inline_button_text');
        hand.style.display = "none";
        if (setdamin) setdamin.innerHTML = 'Bitte warte bis ein Admin das Spiel startet.';
      }

      // Rebuild player table
      var table = document.getElementById('player_tbody');
      table.innerHTML = '';
      for (num in res.User) {
        var juser = res.User[num];
        var tr = document.createElement('tr');
        var th = document.createElement('th');
        th.className = 'counterCell';
        th.scope = 'row';
        var td = document.createElement('td');
        var nameHtml = juser['Name'];
        if (juser['Is_Admin']) nameHtml += ' <span class="admin-badge"><i class="fas fa-star" title="Admin"></i></span>';
        if (juser['Pending_Join']) nameHtml += ' <small>(wartet)</small>';
        td.innerHTML = nameHtml;
        tr.appendChild(th);
        tr.appendChild(td);
        table.appendChild(tr);

        if (juser['Id'] == id) {
          var name = document.getElementById('Name');
          name.disabled = true;
          var btn = document.getElementById('jointbtn');
          btn.disabled = true;
        }
      }

      if (sate == 'started' || sate == 'playfinal') {
        window.location.href = "/game/" + gameid;
      }
    }
  });
</script>
{% endblock %}

{% extends "base.html" %}


{% block content %}
{{ super() }}
<div id="joincontainer">
  <div class="row col-md-offset-1">
    <div class="col-md-10">
      <h2>Zum Beitreten Spielname angeben.</h2>
    </div>
  </div>

  <div class="row col-md-offset-1">
    <div class="col-md-3 " >
      <div class="input-group mb-6">
        <input id="Name" placeholder="Spielername" type="text" size="20" class="form-control" onkeydown="if(event.key==='Enter')joinGame()" autofocus>
        <div class="input-group-btn">
          <button id="jointbtn" class="btn btn-primary btn-outline-secondary" type="button" onclick="joinGame()">Beitreten</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row col-md-offset-1">
  <div class="col-md-11">
    <h3 id="admin"></h3>
  </div>
</div>
<br>

<div class="row">
  <div class="col-md-3 col-md-offset-1">
    <div class="row">
      <div class="col-md-12">
        <h2>Spielerliste:</h2>
      </div>
    </div>
    <table class="table table-striped table-hover" >
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
        </tr>
      </thead>
      <tbody id="player_tbody">
        {% for user in game.users %}
        <tr >
          <th class="counterCell" scope="row"></th>
            <td>
              {{ user.name }}
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
  </div>
</div>


<div class="row col-md-offset-1 col-md-10">
    <h3 id="share_heading">Verteile diesen Link an alle Mitspieler:</h3>
</div>
<div class="row">
  <div class="col-md-offset-1 col-md-4" >
    <div class="input-group mb-6">
      <input id="link_input" type="text" size="80" class="form-control" value="/game_waiting/{{game.UUID}}">
      <div class="input-group-btn">
        <button onclick="coppy()" class="btn btn-outline-secondary" type="button">kopieren</button>
      </div>
    </div>
    <div id="qrcode" style="margin-top: 12px; padding: 20px;"></div>
    <button id="switch_device_btn" onclick="toggleDeviceSwitch()" class="btn btn-outline-secondary btn-sm" style="margin-top: 8px;">Ger√§t wechseln</button>
  </div>
</div>
<div class="row col-md-offset-1 admin_interface">
  <div class="col-md-9">
    <h3>Spiel starten (<b>Du kannst Spieler auch nachtr√§glich hinzuf√ºgen</b>)</h3>
  </div>
</div>
<div class="row col-md-offset-1 admin_interface">
  <div class="col-md-9">
    <label for="ruleset_select">Ruleset w√§hlen:</label>
    <select name="ruleset_select" id="ruleset_select" class="form-select">
      <option value="">-- Wird geladen --</option>
    </select>
    <div style="margin-top: 8px;">
      <label><input type="checkbox" id="falling_dice_cb"> W√ºrfel k√∂nnen vom Tisch fallen (Schnapsrunde)</label>
    </div>
  </div>
</div>
<div class="row col-md-offset-1 admin_interface">
  <div class="col-md-1" >
    <button class="btn btn-primary" id='startgame_id' onclick="startGame()" disabled>Starten</button>
    <div id="inline_button_text" >
      <h3>üëà</h3>
    </div>
  </div>
</div>


<div class="row col-md-offset-1 col-md-10" >
    <p id="admin_id" hidden>{{ game.admin_user_id }}</p>
    <p id="admins_data" hidden>{{ game.users | selectattr('is_admin') | map(attribute='id') | list }}</p>
</div>
<div class="row col-md-offset-1 col-md-10" >
    <p id="UUID" hidden>{{game.UUID}}</p>
</div>
{% if game.ruleset_id %}
<p id="current_ruleset_id" hidden>{{game.ruleset_id}}</p>
{% endif %}



{% endblock %}
{% block scripts %}
{{ super() }}

<script type=text/javascript src="{{url_for('static', filename='scripts/socket.io.js') }}">
</script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
  // Handle device switch: read params from URL and set localStorage
  (function() {
    var params = new URLSearchParams(window.location.search);
    var switchId = params.get('switch_id');
    var switchName = params.get('switch_name');
    if (switchId && switchName) {
      localStorage.setItem('id', switchId);
      localStorage.setItem('name', switchName);
      params.delete('switch_id');
      params.delete('switch_name');
      var newUrl = window.location.pathname;
      var remaining = params.toString();
      if (remaining) newUrl += '?' + remaining;
      window.history.replaceState({}, '', newUrl);
    }
  })();

  // Pre-fill nickname from localStorage
  (function() {
    var savedName = localStorage.getItem('name');
    if (savedName) {
      var inp = document.getElementById('Name');
      if (inp && !inp.value) inp.value = savedName;
    }
  })();

  // https://www.w3schools.com/howto/howto_js_copy_clipboard.asp
  function coppy() {
    var copyText = document.getElementById("link_input");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    document.execCommand("copy");
  }

  // Generate QR code for the game link
  (function() {
    var loc = window.location;
    var fullUrl = loc.protocol + '//' + loc.host + '/game_waiting/{{game.UUID}}';
    new QRCode(document.getElementById('qrcode'), {
      text: fullUrl,
      width: 160,
      height: 160,
      colorDark: '#000000',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.M
    });
  })();

  // Toggle between invite link and device-switch link
  var _showingDeviceSwitch = false;
  function toggleDeviceSwitch() {
    var myId = localStorage.getItem('id');
    var myName = localStorage.getItem('name');
    if (!myId || !myName) {
      alert('Du musst erst dem Spiel beitreten.');
      return;
    }
    var btn = document.getElementById('switch_device_btn');
    var linkInput = document.getElementById('link_input');
    var qrContainer = document.getElementById('qrcode');
    var loc = window.location;
    var gameUUID = document.getElementById('UUID').innerHTML.replace(/['"]+/g, '').trim();

    var heading = document.getElementById('share_heading');

    if (!_showingDeviceSwitch) {
      var deviceUrl = loc.protocol + '//' + loc.host + '/game_waiting/' + gameUUID
                    + '?switch_id=' + encodeURIComponent(myId)
                    + '&switch_name=' + encodeURIComponent(myName);
      linkInput.value = deviceUrl;
      qrContainer.innerHTML = '';
      new QRCode(qrContainer, {
        text: deviceUrl, width: 160, height: 160,
        colorDark: '#000000', colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
      });
      btn.textContent = 'Spieler einladen';
      heading.textContent = 'Behalte diesen Link f√ºr dich:';
      _showingDeviceSwitch = true;
    } else {
      var inviteUrl = loc.protocol + '//' + loc.host + '/game_waiting/' + gameUUID;
      linkInput.value = inviteUrl;
      qrContainer.innerHTML = '';
      new QRCode(qrContainer, {
        text: inviteUrl, width: 160, height: 160,
        colorDark: '#000000', colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
      });
      btn.textContent = 'Ger√§t wechseln';
      heading.textContent = 'Verteile diesen Link an alle Mitspieler:';
      _showingDeviceSwitch = false;
    }
  }

  var _rulesets = [];

  function loadRulesets() {
    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", "/api/rulesets");
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function() {
      if (xhttp.readyState == XMLHttpRequest.DONE && xhttp.status == 200) {
        _rulesets = JSON.parse(xhttp.responseText);
        var select = document.getElementById('ruleset_select');
        select.innerHTML = '';
        for (var i = 0; i < _rulesets.length; i++) {
          var opt = document.createElement('option');
          opt.value = _rulesets[i].id;
          opt.innerHTML = _rulesets[i].name;
          select.appendChild(opt);
        }
        // Pre-select current ruleset if returning to lobby
        var currentEl = document.getElementById('current_ruleset_id');
        if (currentEl && currentEl.innerHTML.trim()) {
          select.value = currentEl.innerHTML.trim();
        }
      }
    }
    xhttp.send();
  }

  function joinGame() {
    var user = document.getElementById('Name');
    var game = document.getElementById('UUID');
    var uuid = game.innerHTML;
    uuid = uuid.replace(/^"(.+)"$/,'$1');
    var usernname = user.value;
    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/api/game/"+uuid+"/user");
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function() {
      if (xhttp.readyState == XMLHttpRequest.DONE) {
        var res = JSON.parse(xhttp.responseText);
        if (xhttp.status != 200) {
          alert('Fehler beim erzeugen: '+res.Message);
          location = location;
        } else {
          localStorage.setItem('name', usernname);
          for (num in res.User) {
            var juser = res.User[num];
            var name = juser['Name'];
            if (name == usernname) {
              localStorage.setItem('id', juser['Id']);
            }
          }
          window.location.href = "/game_waiting/"+uuid;
        }
      }
    }
    var payload = {name: usernname};
    var oldId = localStorage.getItem('id');
    if (oldId) payload.reconnect_id = parseInt(oldId);
    xhttp.send(JSON.stringify(payload));
  }

  function startGame() {
    var game = document.getElementById('UUID');
    var gameid = game.innerHTML;
    gameid = gameid.replace(/^"(.+)"$/,'$1');

    var rulesetSelect = document.getElementById('ruleset_select');
    var rulesetId = rulesetSelect.value;
    var myId = parseInt(localStorage.getItem('id'));

    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/api/game/"+gameid+"/start");
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function() {
      if (xhttp.readyState == XMLHttpRequest.DONE) {
        if (xhttp.status != 201) {
          try {
            var res = JSON.parse(xhttp.responseText);
            alert(''+res.Message);
          } catch (e) {
            alert('Allgemeiner Fehler');
          }
        }
      }
    }
    var fallingDice = document.getElementById('falling_dice_cb').checked;
    xhttp.send(JSON.stringify({ruleset_id: rulesetId, admin_id: myId, falling_dice: fallingDice}));
  }

  function isAdminUser() {
    var myId = parseInt(localStorage.getItem('id'));
    // Check from the game state if available
    if (window._currentGame && window._currentGame.Admins) {
      return window._currentGame.Admins.indexOf(myId) !== -1;
    }
    // Fallback: check from template data
    var adminEl = document.getElementById('admin_id');
    if (adminEl) {
      return myId == parseInt(adminEl.innerHTML);
    }
    return false;
  }

  function startup() {
    var gameLink = document.getElementById("link_input");
    gameLink.value = window.location.href;

    loadRulesets();

    var id = localStorage.getItem('id');
    var setdamin = document.getElementById('admin');

    // Fetch game state to check admin status
    var game = document.getElementById('UUID');
    var gameid = game.innerHTML;
    gameid = gameid.replace(/^"(.+)"$/,'$1');

    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", "/api/game/" + gameid);
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.onreadystatechange = function() {
      if (xhttp.readyState == XMLHttpRequest.DONE && xhttp.status == 200) {
        var gameData = JSON.parse(xhttp.responseText);
        window._currentGame = gameData;
        var myId = parseInt(id);

        // Stale localStorage check: if another user now has our stored ID,
        // clear localStorage so the user can rejoin fresh
        if (myId) {
          var storedName = localStorage.getItem('name');
          for (var i = 0; i < gameData.User.length; i++) {
            if (gameData.User[i].Id === myId && gameData.User[i].Name !== storedName) {
              localStorage.removeItem('id');
              localStorage.removeItem('name');
              myId = NaN;
              id = null;
              break;
            }
          }
        }

        var amAdmin = gameData.Admins && gameData.Admins.indexOf(myId) !== -1;

        if (!amAdmin) {
          var all_admin_elements = document.getElementsByClassName("admin_interface");
          for (var i = 0; i < all_admin_elements.length; i++) {
            all_admin_elements[i].style.display = "none";
          }
          var button = document.getElementById('startgame_id');
          button.style.display = "none";
          var hand = document.getElementById('inline_button_text');
          hand.style.display = "none";
          setdamin.innerHTML = 'Bitte warte bis ein Admin das Spiel startet.';
        } else {
          var joincontainer = document.getElementById('joincontainer');
          joincontainer.style.display = "none";
          var button = document.getElementById('startgame_id');
          button.disabled = false;
          var hand = document.getElementById('inline_button_text');
          hand.style.webkitAnimationName = 'run';
          setdamin.innerHTML = 'Du bist Admin. Bitte starten wenn alle Spieler in der Liste stehen.';
        }

        // Restore falling dice checkbox from current game state
        var fallingCb = document.getElementById('falling_dice_cb');
        if (fallingCb && gameData.Falling_Dice !== undefined) {
          fallingCb.checked = gameData.Falling_Dice;
        }

        // Restore selected ruleset
        if (gameData.Ruleset_Id) {
          var rulesetSel = document.getElementById('ruleset_select');
          if (rulesetSel) rulesetSel.value = gameData.Ruleset_Id;
        }
      }
    }
    xhttp.send();
  }
  startup();
</script>

<script type="text/javascript" charset="utf-8">
  namespace = '/game';

  const socket = io(namespace, {
    reconnection: true,
    reconnectionAttempts: Infinity,
    reconnectionDelay: 1000,
    reconnectionDelayMax: 5000,
    randomizationFactor: 0.5
  });

  socket.on('connect', function() {
    var game = document.getElementById('UUID');
    var gameid = game.innerHTML;
    gameid = gameid.replace(/^"(.+)"$/,'$1');
    socket.emit('join', {room: gameid});
  });

  socket.on('reload_game', function(game, cb) {
    if (game) {
      var game_el = document.getElementById('UUID');
      var gameid = game_el.innerHTML;
      gameid = gameid.replace(/^"(.+)"$/,'$1');

      window._currentGame = game;
      var id = localStorage.getItem('id');
      var res = game;
      var sate = res.State;

      // Update admin visibility dynamically
      var myId = parseInt(id);
      var amAdmin = res.Admins && res.Admins.indexOf(myId) !== -1;
      var all_admin_elements = document.getElementsByClassName("admin_interface");
      var setdamin = document.getElementById('admin');
      if (amAdmin) {
        for (var i = 0; i < all_admin_elements.length; i++) {
          all_admin_elements[i].style.display = '';
        }
        var joincontainer = document.getElementById('joincontainer');
        joincontainer.style.display = "none";
        var button = document.getElementById('startgame_id');
        button.disabled = false;
        button.style.display = '';
        var hand = document.getElementById('inline_button_text');
        hand.style.display = '';
        if (setdamin) setdamin.innerHTML = 'Du bist Admin. Bitte starten wenn alle Spieler in der Liste stehen.';
      } else {
        for (var i = 0; i < all_admin_elements.length; i++) {
          all_admin_elements[i].style.display = "none";
        }
        var button = document.getElementById('startgame_id');
        button.style.display = "none";
        var hand = document.getElementById('inline_button_text');
        hand.style.display = "none";
        if (setdamin) setdamin.innerHTML = 'Bitte warte bis ein Admin das Spiel startet.';
      }

      // Rebuild player table
      var table = document.getElementById('player_tbody');
      table.innerHTML = '';
      var myIdInGame = false;
      for (num in res.User) {
        var juser = res.User[num];
        var tr = document.createElement('tr');
        var th = document.createElement('th');
        th.className = 'counterCell';
        th.scope = 'row';
        var td = document.createElement('td');
        var nameHtml = juser['Name'];
        if (juser['Pending_Join']) nameHtml += ' <small>(wartet)</small>';
        td.innerHTML = nameHtml;
        tr.appendChild(th);
        tr.appendChild(td);
        table.appendChild(tr);

        if (id && String(juser['Id']) === String(id)) {
          myIdInGame = true;
        }
      }
      var nameInput = document.getElementById('Name');
      var joinBtn = document.getElementById('jointbtn');
      if (myIdInGame) {
        nameInput.disabled = true;
        joinBtn.disabled = true;
      } else {
        nameInput.disabled = false;
        joinBtn.disabled = false;
      }

      if (sate == 'started' || sate == 'playfinal') {
        window.location.href = "/game/" + gameid;
      }
    }
  });
</script>
{% endblock %}
